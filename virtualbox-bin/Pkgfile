# Description: Virtualisation software for x86 hardware (binary version, non-GPL)
# URL:         http://www.virtualbox.org
# Packager:    Lin SiFuh
# Maintainer:  
# Depends on:  libidl libxslt xorg-libxinerama xorg-libxcursor

name=virtualbox-bin
version=6.1.2
sversion=135662
#version=6.0.12-133076
release=2
source=(http://download.virtualbox.org/virtualbox/$version/VirtualBox-$version-$sversion-Linux_amd64.run \
        vbox_build_module 60-vboxdrv.rules)

build () {
    sh VirtualBox-${version}-${sversion}-Linux_amd64.run --keep --noexec --target $SRC/
    mkdir -p $PKG/etc/vbox $PKG/opt/VirtualBox $PKG/sbin $PKG/opt/bin $PKG/opt/share/pixmaps/ \
             $PKG/opt/share/applications/ $PKG/opt/share/mime/packages/ $PKG/opt/src/ \
             $PKG/opt/share/icons/hicolor/{16x16,20x20,24x24,32x32,48x48}/{mimetypes,apps} \
             $PKG/opt/share/icons/hicolor/{64x64,72x72,96x96,128x128,256x256}/{mimetypes,apps} \
             $PKG/etc/udev/rules.d/

    cd $PKG/opt/VirtualBox
    tar xfj $SRC/VirtualBox.tar.bz2
    install -m 755 $SRC/vbox_build_module $PKG/opt/bin/

    # Create symlinks to start binaries
    ln -sf /opt/VirtualBox/VBox.sh $PKG/opt/bin/VirtualBox
    if [ -f $PKG/opt/VirtualBox/VirtualBoxVM ]; then
        ln -sf /opt/VirtualBox/VBox.sh $PKG/opt/bin/VirtualBoxVM
    fi
    ln -sf /opt/VirtualBox/VBox.sh $PKG/opt/bin/VBoxSDL
    ln -sf /opt/VirtualBox/VBox.sh $PKG/opt/bin/VBoxHeadless
    ln -sf /opt/VirtualBox/VBox.sh $PKG/opt/bin/VBoxBalloonCtrl
    ln -sf /opt/VirtualBox/VBox.sh $PKG/opt/bin/vboxwebsrv
    ln -sf /opt/VirtualBox/vbox-img $PKG/opt/bin/vbox-img
    ln -sf /opt/VirtualBox/VBox.png $PKG/opt/share/pixmaps/VBox.png
    ln -sf /opt/VirtualBox/VBox.sh $PKG/opt/bin/VBoxManage
    ln -sf /opt/VirtualBox/VBox.sh $PKG/opt/bin/VBoxVRDP
    ln -sf /opt/VirtualBox/VBox.sh $PKG/opt/bin/VBoxBugReport
    if [ -f $PKG/opt/VirtualBox/VBoxDTrace ]; then
        ln -sf /opt/VirtualBox/VBox.sh $PKG/opt/bin/VBoxDTrace
    fi
    ln -sf /opt/VirtualBox/vboxdrv.sh $PKG/sbin/rcvboxdrv

    for n in VBoxVMM.so VBoxRT.so; do
        ln -sf /opt/VirtualBox/${n} components
    done
    chmod go-w .

    # Icons
    cur=`pwd`
    cd $PKG/opt/VirtualBox/icons
    for i in *; do
        cd $i
        if [ -d $PKG/opt/share/icons/hicolor/$i ]; then
            for j in *; do
                if expr "$j" : "virtualbox\..*" > /dev/null; then
                    dst=apps
                else
                    dst=mimetypes
                fi
                if [ -d $PKG/opt/share/icons/hicolor/$i/$dst ]; then
                    ln -s /opt/VirtualBox/icons/$i/$j $PKG/opt/share/icons/hicolor/$i/$dst/$j
                fi
            done
        fi
        cd -
    done
    cd $cur

   # Remove junk
   find nls -type f ! -name '*en*' -exec rm -f {} \; 
   rm -rf $PKG/opt/VirtualBox/sdk
 
   # Install udev rules
   install -m644 $SRC/60-vboxdrv.rules $PKG/etc/udev/rules.d/60-vboxdrv.rules

   echo "# VirtualBox installation directory" > $PKG/etc/vbox/vbox.cfg
   echo "INSTALL_DIR="\"/opt/VirtualBox\" >> $PKG/etc/vbox/vbox.cfg
   chmod 4511 $PKG/opt/VirtualBox/{VirtualBoxVM,VBoxSDL,VBoxHeadless,VBoxNetAdpCtl,VBoxVolInfo,VBoxNetDHCP,VBoxNetNAT}

}
